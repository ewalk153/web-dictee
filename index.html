<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dictation Practice</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    .correct { background-color: lightgreen; transition: background-color 0.5s; }
    .incorrect { background-color: lightcoral; transition: background-color 0.5s; }
    input, select, button { font-size: 18px; margin: 5px; }
    li { margin: 6px 0; }
  </style>
</head>
<body>
  <h1>Dictation Practice</h1>
  <div>
    <button onclick="switchMode('setup')">Setup Mode</button>
    <button onclick="switchMode('play')">Play Mode</button>
  </div>

  <!-- Setup Mode -->
  <div id="setup" style="display:none;">
    <h2>Setup Mode</h2>
    <input id="listName" placeholder="Word List Name">
    <button onclick="createList()">Create List</button><br>

    <select id="wordListSelect" onchange="updateWordListPreview()"></select><br>
    <input id="wordInput" placeholder="Word">
    <button onclick="startRecording()">üé§ Record</button>
    <button onclick="stopRecording()">‚èπ Stop</button>
    <button onclick="saveWord()">Save Word</button>

    <div id="recordIndicator" style="display: none; margin-top: 10px;">
      <span id="recordDot" style="font-size: 24px; color: red;">‚óè</span>
      <span id="recordTime">0.0</span> sec
    </div>

    <h3>Words in List: <span id="currentListName"></span></h3>
    <ul id="wordPreview" style="list-style: none; padding: 0;" ondragover="event.preventDefault()" ondrop="handleDrop(event)"></ul>
  </div>

  <!-- Play Mode -->
  <div id="play" style="display:none;">
    <h2>Play Mode</h2>
    <select id="playListSelect"></select><br>
    <button onclick="startGame()">Start</button><br>
    <button onclick="playAudio()">üîÅ Replay</button><br>
    <input id="answerInput" placeholder="Type the word" onkeyup="checkAnswer(event)">
  </div>

  <script>
    let recordTimer = null;
    let recordStartTime = null;
    let currentAudioBlob = null;
    let mediaRecorder, currentWord, currentList = [];
    let dragIndex = null;

    function switchMode(mode) {
      document.getElementById('setup').style.display = mode === 'setup' ? 'block' : 'none';
      document.getElementById('play').style.display = mode === 'play' ? 'block' : 'none';
      if (mode === 'setup') loadLists(); else populatePlayLists();
    }

    function createList() {
      const name = document.getElementById('listName').value.trim();
      if (!name) return alert("Enter list name");
      localStorage.setItem(`list_${name}`, JSON.stringify([]));
      loadLists();
    }

    function loadLists() {
      const select = document.getElementById('wordListSelect');
      select.innerHTML = '';
      Object.keys(localStorage).filter(k => k.startsWith('list_')).forEach(k => {
        const opt = document.createElement('option');
        opt.value = k;
        opt.textContent = k.slice(5);
        select.appendChild(opt);
      });
      updateWordListPreview();
    }

    function updateWordListPreview() {
      const key = document.getElementById('wordListSelect').value;
      const list = JSON.parse(localStorage.getItem(key) || '[]');
      const ul = document.getElementById('wordPreview');
      document.getElementById('currentListName').textContent = key.slice(5);
      ul.innerHTML = '';

      list.forEach((entry, index) => {
        const li = document.createElement('li');
        li.textContent = entry.word + ' ';
        li.draggable = true;
        li.ondragstart = () => dragIndex = index;
        li.dataset.index = index;

        const playBtn = document.createElement('button');
        playBtn.textContent = 'üéß';
        playBtn.onclick = () => {
          const audio = new Audio(entry.audio);
          audio.play();
        };

        const delBtn = document.createElement('button');
        delBtn.textContent = '‚ùå';
        delBtn.onclick = () => {
          list.splice(index, 1);
          localStorage.setItem(key, JSON.stringify(list));
          updateWordListPreview();
        };

        const moveBtn = document.createElement('button');
        moveBtn.textContent = 'üì§';
        moveBtn.onclick = () => moveWordToAnotherList(index);

        li.appendChild(playBtn);
        li.appendChild(delBtn);
        li.appendChild(moveBtn);
        ul.appendChild(li);
      });
    }

    function handleDrop(event) {
      const key = document.getElementById('wordListSelect').value;
      const list = JSON.parse(localStorage.getItem(key) || '[]');
      const dropIndex = [...event.currentTarget.children].indexOf(event.target.closest('li'));
      if (dragIndex === null || dropIndex < 0 || dragIndex === dropIndex) return;

      const [movedItem] = list.splice(dragIndex, 1);
      list.splice(dropIndex, 0, movedItem);
      localStorage.setItem(key, JSON.stringify(list));
      dragIndex = null;
      updateWordListPreview();
    }

    function moveWordToAnotherList(index) {
      const fromKey = document.getElementById('wordListSelect').value;
      const fromList = JSON.parse(localStorage.getItem(fromKey) || '[]');
      const wordEntry = fromList[index];

      const otherLists = Object.keys(localStorage)
        .filter(k => k.startsWith('list_') && k !== fromKey);

      const target = prompt("Move to which list?\n" + otherLists.map(k => k.slice(5)).join('\n'));
      if (!target) return;

      const toKey = 'list_' + target.trim();
      if (!localStorage.getItem(toKey)) return alert("That list doesn't exist.");

      fromList.splice(index, 1);
      localStorage.setItem(fromKey, JSON.stringify(fromList));

      const toList = JSON.parse(localStorage.getItem(toKey));
      toList.push(wordEntry);
      localStorage.setItem(toKey, JSON.stringify(toList));

      updateWordListPreview();
    }

function startRecording() {
  navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
    const chunks = [];
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.ondataavailable = e => chunks.push(e.data);
    mediaRecorder.onstop = () => {
      currentAudioBlob = new Blob(chunks);
      stopRecordIndicator();
    };
    mediaRecorder.start();
    startRecordIndicator();
    console.log("Recording started");
  }).catch(err => {
    alert("Could not access microphone: " + err.message);
  });
}

function stopRecording() {
  if (mediaRecorder && mediaRecorder.state === "recording") {
    mediaRecorder.stop();
    console.log("Recording stopped");
  } else {
    alert("Not currently recording.");
  }
}

    function startRecordIndicator() {
  document.getElementById("recordIndicator").style.display = "inline-block";
  recordStartTime = Date.now();
  recordTimer = setInterval(() => {
    const elapsed = ((Date.now() - recordStartTime) / 1000).toFixed(1);
    document.getElementById("recordTime").textContent = elapsed;
    const dot = document.getElementById("recordDot");
    dot.style.visibility = dot.style.visibility === 'hidden' ? 'visible' : 'hidden';
  }, 500);
}

function stopRecordIndicator() {
  clearInterval(recordTimer);
  recordTimer = null;
  document.getElementById("recordIndicator").style.display = "none";
}

    function saveWord() {
      const word = document.getElementById('wordInput').value.trim();
      const listKey = document.getElementById('wordListSelect').value;
      if (!word || !currentAudioBlob) return alert("Missing word or audio");
      const reader = new FileReader();
      reader.onloadend = () => {
        const audioData = reader.result;
        const list = JSON.parse(localStorage.getItem(listKey) || '[]');
        list.push({ word, audio: audioData });
        localStorage.setItem(listKey, JSON.stringify(list));
        updateWordListPreview();
        currentAudioBlob = null;
        document.getElementById('wordInput').value = '';
      };
      reader.readAsDataURL(currentAudioBlob);
    }

    function populatePlayLists() {
      const select = document.getElementById('playListSelect');
      select.innerHTML = '';
      Object.keys(localStorage).filter(k => k.startsWith('list_')).forEach(k => {
        const opt = document.createElement('option');
        opt.value = k;
        opt.textContent = k.slice(5);
        select.appendChild(opt);
      });
    }

    function startGame() {
      const key = document.getElementById('playListSelect').value;
      currentList = JSON.parse(localStorage.getItem(key) || '[]');
      nextTurn();
    }

    function nextTurn() {
      const rand = Math.floor(Math.random() * currentList.length);
      currentWord = currentList[rand];
      document.getElementById('answerInput').value = '';
      playAudio();
    }

    function playAudio() {
      if (!currentWord || !currentWord.audio) return;
      const audio = new Audio(currentWord.audio);
      audio.play();
    }

    function checkAnswer(event) {
      if (event.key !== 'Enter') return;
      const input = document.getElementById('answerInput');
      const answer = input.value.trim().toLowerCase();
      const expected = currentWord.word.toLowerCase();
      if (answer === expected) {
        flash('correct');
        nextTurn();
      } else {
        flash('incorrect');
      }
    }

    function flash(cls) {
      document.body.classList.add(cls);
      setTimeout(() => document.body.classList.remove(cls), 300);
    }
  </script>
</body>
</html>
